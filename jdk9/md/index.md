## 明日から使える Java 9 便利機能 5 選

<a href="https://twitter.com/k_kato" target="_blank"><img style="border-radius: 50% !important;" src="img/twitter.jpg" width="200px" alt="Keisuke KATO"></a> 

#### Javaツール勉強会＠福岡@[AIPカフェ](http://javatoolstudy-fukuoka.connpass.com/event/43600/)

2016/11/4 <a href="https://twitter.com/k_kato" target="_blank">@k_kato</a>



## About me

<!-- .slide: data-background="rgb(0, 43, 54)" -->
```js
const profile = {timeline: [
    {year: 2010, lang: "Java"   },
    {year: 2011, lang: "C#"     },
    {year: 2012, lang: "C#"     },
    {year: 2013, lang: "Java"   },
    {year: 2014, lang: "C#"     },
    {year: 2015, lang: "Java 8" }
]};
```
```js
const addTimeline2016 = (profile) => {
    profile.timeline.push({
        year: 2016,
        lang: "Java 8",
        job: "Web",
        do: "Modern Web Development with C# (100μ%)",
        try: "Microsoft MVP",
        catch: "Failed"
    });
}
```



## Java 9 リリース スケジュール物語

* 😄 2016 年 1 月 - 4 月 リリース予定
<!-- .element: class="fragment" data-fragment-index="10" -->
* 📆 リスケ
<!-- .element: class="fragment" data-fragment-index="20" -->
* 😃 2016 年 9 月 22 日 リリース予定
<!-- .element: class="fragment" data-fragment-index="30" -->
* 📆 リスケ
<!-- .element: class="fragment" data-fragment-index="40" -->
* 😅 2017 年 3 月 23 日 リリース予定
<!-- .element: class="fragment" data-fragment-index="50" -->
* 📆 リスケ
<!-- .element: class="fragment" data-fragment-index="60" -->
* 😱 2017 年 7 月 27 日 リリース決定？
<!-- .element: class="fragment" data-fragment-index="70" -->
* ✋ これはもしかして…
<!-- .element: class="fragment" data-fragment-index="80" -->
* 👍 納期が厳しい現代情報社会に身を挺して一石を投じた Java 9
<!-- .element: class="fragment" data-fragment-index="90" -->
<img src="img/mmm.jpg" height="200px" />
<img src="img/dm.jpg" height="200px" />
<!-- .element: class="fragment" data-fragment-index="90" -->



## Java 9 機能一覧

### [87 機能！！](http://openjdk.java.net/projects/jdk9/)
<!-- .element: class="fragment" data-fragment-index="10" -->
<div style="font-size: 16px">
102: <a href="http://openjdk.java.net/jeps/102">Process API Updates</a>
110: <a href="http://openjdk.java.net/jeps/110">HTTP 2 Client</a>
143: <a href="http://openjdk.java.net/jeps/143">Improve Contended Locking</a>
158: <a href="http://openjdk.java.net/jeps/158">Unified JVM Logging</a>
165: <a href="http://openjdk.java.net/jeps/165">Compiler Control</a>
193: <a href="http://openjdk.java.net/jeps/193">Variable Handles</a>
197: <a href="http://openjdk.java.net/jeps/197">Segmented Code Cache</a>
199: <a href="http://openjdk.java.net/jeps/199">Smart Java Compilation, Phase Two</a>
200: <a href="http://openjdk.java.net/jeps/200">The Modular JDK</a>
201: <a href="http://openjdk.java.net/jeps/201">Modular Source Code</a>
211: <a href="http://openjdk.java.net/jeps/211">Elide Deprecation Warnings on Import Statements</a>
212: <a href="http://openjdk.java.net/jeps/212">Resolve Lint and Doclint Warnings</a>
213: <a href="http://openjdk.java.net/jeps/213">Milling Project Coin</a>
214: <a href="http://openjdk.java.net/jeps/214">Remove GC Combinations Deprecated in JDK 8</a>
215: <a href="http://openjdk.java.net/jeps/215">Tiered Attribution for javac</a>
216: <a href="http://openjdk.java.net/jeps/216">Process Import Statements Correctly</a>
217: <a href="http://openjdk.java.net/jeps/217">Annotations Pipeline 2.0</a>
219: <a href="http://openjdk.java.net/jeps/219">Datagram Transport Layer Security (DTLS)</a>
220: <a href="http://openjdk.java.net/jeps/220">Modular Run-Time Images</a>
221: <a href="http://openjdk.java.net/jeps/221">Simplified Doclet API</a>
222: <a href="http://openjdk.java.net/jeps/222">jshell: The Java Shell (Read-Eval-Print Loop)</a>
223: <a href="http://openjdk.java.net/jeps/223">New Version-String Scheme</a>
224: <a href="http://openjdk.java.net/jeps/224">HTML5 Javadoc</a>
225: <a href="http://openjdk.java.net/jeps/225">Javadoc Search</a>
226: <a href="http://openjdk.java.net/jeps/226">UTF-8 Property Files</a>
227: <a href="http://openjdk.java.net/jeps/227">Unicode 7.0</a>
228: <a href="http://openjdk.java.net/jeps/228">Add More Diagnostic Commands</a>
229: <a href="http://openjdk.java.net/jeps/229">Create PKCS12 Keystores by Default</a>
231: <a href="http://openjdk.java.net/jeps/231">Remove Launch-Time JRE Version Selection</a>
232: <a href="http://openjdk.java.net/jeps/232">Improve Secure Application Performance</a>
233: <a href="http://openjdk.java.net/jeps/233">Generate Run-Time Compiler Tests Automatically</a>
235: <a href="http://openjdk.java.net/jeps/235">Test Class-File Attributes Generated by javac</a>
236: <a href="http://openjdk.java.net/jeps/236">Parser API for Nashorn</a>
237: <a href="http://openjdk.java.net/jeps/237">Linux/AArch64 Port</a>
238: <a href="http://openjdk.java.net/jeps/238">Multi-Release JAR Files</a>
240: <a href="http://openjdk.java.net/jeps/240">Remove the JVM TI hprof Agent</a>
241: <a href="http://openjdk.java.net/jeps/241">Remove the jhat Tool</a>
243: <a href="http://openjdk.java.net/jeps/243">Java-Level JVM Compiler Interface</a>
244: <a href="http://openjdk.java.net/jeps/244">TLS Application-Layer Protocol Negotiation Extension</a>
245: <a href="http://openjdk.java.net/jeps/245">Validate JVM Command-Line Flag Arguments</a>
246: <a href="http://openjdk.java.net/jeps/246">Leverage CPU Instructions for GHASH and RSA</a>
247: <a href="http://openjdk.java.net/jeps/247">Compile for Older Platform Versions</a>
248: <a href="http://openjdk.java.net/jeps/248">Make G1 the Default Garbage Collector</a>
249: <a href="http://openjdk.java.net/jeps/249">OCSP Stapling for TLS</a>
250: <a href="http://openjdk.java.net/jeps/250">Store Interned Strings in CDS Archives</a>
251: <a href="http://openjdk.java.net/jeps/251">Multi-Resolution Images</a>
252: <a href="http://openjdk.java.net/jeps/252">Use CLDR Locale Data by Default</a>
253: <a href="http://openjdk.java.net/jeps/253">Prepare JavaFX UI Controls &amp; CSS APIs for Modularization</a>
254: <a href="http://openjdk.java.net/jeps/254">Compact Strings</a>
255: <a href="http://openjdk.java.net/jeps/255">Merge Selected Xerces 2.11.0 Updates into JAXP</a>
256: <a href="http://openjdk.java.net/jeps/256">BeanInfo Annotations</a>
257: <a href="http://openjdk.java.net/jeps/257">Update JavaFX/Media to Newer Version of GStreamer</a>
258: <a href="http://openjdk.java.net/jeps/258">HarfBuzz Font-Layout Engine</a>
259: <a href="http://openjdk.java.net/jeps/259">Stack-Walking API</a>
260: <a href="http://openjdk.java.net/jeps/260">Encapsulate Most Internal APIs</a>
261: <a href="http://openjdk.java.net/jeps/261">Module System</a>
262: <a href="http://openjdk.java.net/jeps/262">TIFF Image I/O</a>
263: <a href="http://openjdk.java.net/jeps/263">HiDPI Graphics on Windows and Linux</a>
264: <a href="http://openjdk.java.net/jeps/264">Platform Logging API and Service</a>
265: <a href="http://openjdk.java.net/jeps/265">Marlin Graphics Renderer</a>
266: <a href="http://openjdk.java.net/jeps/266">More Concurrency Updates</a>
267: <a href="http://openjdk.java.net/jeps/267">Unicode 8.0</a>
268: <a href="http://openjdk.java.net/jeps/268">XML Catalogs</a>
269: <a href="http://openjdk.java.net/jeps/269">Convenience Factory Methods for Collections</a>
270: <a href="http://openjdk.java.net/jeps/270">Reserved Stack Areas for Critical Sections</a>
271: <a href="http://openjdk.java.net/jeps/271">Unified GC Logging</a>
272: <a href="http://openjdk.java.net/jeps/272">Platform-Specific Desktop Features</a>
273: <a href="http://openjdk.java.net/jeps/273">DRBG-Based SecureRandom Implementations</a>
274: <a href="http://openjdk.java.net/jeps/274">Enhanced Method Handles</a>
275: <a href="http://openjdk.java.net/jeps/275">Modular Java Application Packaging</a>
276: <a href="http://openjdk.java.net/jeps/276">Dynamic Linking of Language-Defined Object Models</a>
277: <a href="http://openjdk.java.net/jeps/277">Enhanced Deprecation</a>
278: <a href="http://openjdk.java.net/jeps/278">Additional Tests for Humongous Objects in G1</a>
279: <a href="http://openjdk.java.net/jeps/279">Improve Test-Failure Troubleshooting</a>
280: <a href="http://openjdk.java.net/jeps/280">Indify String Concatenation</a>
281: <a href="http://openjdk.java.net/jeps/281">HotSpot C++ Unit-Test Framework</a>
282: <a href="http://openjdk.java.net/jeps/282">jlink: The Java Linker</a>
283: <a href="http://openjdk.java.net/jeps/283">Enable GTK 3 on Linux</a>
284: <a href="http://openjdk.java.net/jeps/284">New HotSpot Build System</a>
285: <a href="http://openjdk.java.net/jeps/285">Spin-Wait Hints</a>
287: <a href="http://openjdk.java.net/jeps/287">SHA-3 Hash Algorithms</a>
288: <a href="http://openjdk.java.net/jeps/288">Disable SHA-1 Certificates</a>
289: <a href="http://openjdk.java.net/jeps/289">Deprecate the Applet API</a>
290: <a href="http://openjdk.java.net/jeps/290">Filter Incoming Serialization Data</a>
292: <a href="http://openjdk.java.net/jeps/292">Implement Selected ECMAScript 6 Features in Nashorn</a>
294: <a href="http://openjdk.java.net/jeps/294">Linux/s390x Port</a>
295: <a href="http://openjdk.java.net/jeps/295">Ahead-of-Time Compilation</a>

Last update: 2016/10/26 23:19 UTC
</div>
<!-- .element: class="fragment" data-fragment-index="10" -->



## jshell

* [Kulla Project](http://openjdk.java.net/projects/kulla/) ~~(蔵プロジェクト)~~
* [JEP 222: jshell: The Java Shell (a Java REPL)](https://bugs.openjdk.java.net/browse/JDK-8043364)
* REPL (👎レプル  👍リプル)
<!-- .element: class="fragment" data-fragment-index="10" -->
* Read-eval-print loop
<!-- .element: class="fragment" data-fragment-index="20" -->
* 読込-評価-表示 繰り返す
<!-- .element: class="fragment" data-fragment-index="20" -->
```bash
jshell> 1+1
$1 ==> 2
```
<!-- .element: class="fragment" data-fragment-index="20" -->
![http://blog.arungupta.me/jdk9-repl-getting-started/](img/jdk9-repl.png)
<!-- .element: class="fragment" data-fragment-index="20" -->



## jshell をはじめるには？

* 方法 1: JDK 9 をインストールして直接実行
  * [JDK™ 9 Early Access Releases](https://jdk9.java.net/download/) から JDK を D&I
```bash
$JAVA_HOME/bin/jshell
```

* 方法 2: Docker 上で実行
  * [Dockerを使ってJava9を超高速に試す](https://qiita.com/koduki/items/c4fb0276cc0d9a1a08c0)@[koduki](https://qiita.com/koduki)
```bash
docker run marvambass/oracle-java9 java -version
docker run -it marvambass/oracle-java9 jshell
```



### jshell で Java 9 Stream 新機能を確認する

```bash
jshell> import java.util.function.*
jshell> Predicate<Integer> lessThanZero = x -> x < 0
jshell> List.of(-2, -1, 0, 1, 2).
   ...> stream().
   ...> dropWhile(lessThanZero).
   ...> forEach(System.out::println)
0
1
2
jshell> /exit
```

* `Tab` で補完
* 必要なパッケージは `import` で読み込む
* 複数行は `.` で終端する
* 終了は `/exit`
* ヘルプは `/?`
* セミコロン レス Java！素晴らしい！
<!-- .element: class="fragment" data-fragment-index="10" -->



## jshell を使った感想

* REPL なら IDE デバッガー時の即時評価の方が高機能では？
<!-- .element: class="fragment" data-fragment-index="20" -->
  * jshell は import の自動補完機能がない(´；ω；｀)
<!-- .element: class="fragment" data-fragment-index="20" -->
  * IntelliJ IDEA なら Evaluate Expression 中に import も自動補完
<!-- .element: class="fragment" data-fragment-index="20" -->
* Java の公式 REPL なのにメソッド参照の補完ができない(´；ω；｀)
<!-- .element: class="fragment" data-fragment-index="30" -->
  * `System.out::` + `Tab` で補完候補が表示されない
<!-- .element: class="fragment" data-fragment-index="30" -->
* javac と jshell に挙動差がある(´；ω；｀)
<!-- .element: class="fragment" data-fragment-index="40" -->
  * クロージャーについて，JDK 9 javac だと事実上の final でコンパイル エラーなのに，REPL だと不純クロージャーとして評価される
<!-- .element: class="fragment" data-fragment-index="40" -->

```java
import java.util.function.*;

public class Main {
    public static void main(String... args) {
        int x = 0;
        Supplier<Integer> add = () -> x++;
        System.out.println(add.get());
    }
}
```
<!-- .element: class="fragment" data-fragment-index="40" -->



## Java Module System

* [Project Jigsaw](http://openjdk.java.net/projects/jigsaw/)
* [JSR 376: Modularization of the JDK under Project Jigsaw (Java Module System)](http://openjdk.java.net/projects/jigsaw/doc/draft-java-module-system-requirements-12)
* JAR Hell: 同一パッケージのバージョン違いで衝突した場合などで，突然挙動が変わることがある
<!-- .element: class="fragment" data-fragment-index="10" -->
 * java -cp "commons-math3-3.0.jar;commons-math3-3.6.1.jar;" で実行した場合，3.0 が先勝で，3.6.1 は使えない
<!-- .element: class="fragment" data-fragment-index="10" -->
* パッケージの可視性を制御する機能
<!-- .element: class="fragment" data-fragment-index="15" -->
 * クラスやメソッドには public/protected/private があるが，パッケージにはなかった
<!-- .element: class="fragment" data-fragment-index="15" -->
* ライブラリを公開する側が，公開/非公開パッケージを宣言できる
<!-- .element: class="fragment" data-fragment-index="20" -->
* ライブラリを使用する側が，使用/未使用パッケージを宣言できる
<!-- .element: class="fragment" data-fragment-index="20" -->
* ES2015 や Typescript の Modules の Java 版
<!-- .element: class="fragment" data-fragment-index="30" -->



### Java Module System の使い方

* 必要なバイナリは JDK 9 の javac と java のみ
```bash
javac -d modules/com.lib.open src/com/lib/open/module-info.java src/com/lib/open/*
javac -p modules -d modules/com.product src/com/product/module-info.java src/com/product/Main.java
java -p modules -m com.product/com.product.Main
```
   * -p: モジュールを探索するディレクトリを指定する
   * -m: モジュールのメイン クラスを指定する

* ライブラリ側で，公開/非公開パッケージを宣言できる
```java
module com.lib.open { // src/lib/module-info.java
    exports com.lib.open;
}
```
* プロダクト側で，使用/未使用パッケージを宣言できる
```java
module com.product { // src/product/module-info.java
    requires com.lib.open;
    //　requires com.lib.close;
}
```



## Java Module System 構成例

```bash
.
└── src
    └── com
        ├── lib                      (L) ライブラリ
        │   │
        │   ├── close                 (L-1) 非公開パッケージ（クラスやメソッドは public）
        │   │   ├── PrivateB.java
        │   │   └── module-info.java   (L-1-1) 非公開にする旨を `exports` に記述する（未指定）
        │   │
        │   │
        │   └── open                  (L-2) 公開パッケージ
        │       ├── PublicA.java
        │       └── module-info.java   (L-2-1) 公開にする旨を `exports` に記述する
        │
⬆️ライブラリを公開する側
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
⬇️ライブラリを使用する側
        │
        └── product                  (P) ライブラリを使用したプロダクト
            ├── Main.java
            └── module-info.java       (P-1) ライブラリを使用する旨を `requires` に記述する
```



### Java Module System ライブラリ側コード

* 非公開パッケージ

```java
// com.lib.close.PrivateB.java
package com.lib.close; import java.util.function.Function;
public class PrivateB { // 外部には公開したくないが，ライブラリ内部で依存している仮定で public クラス
    public Function<Integer, Integer> addOne = x -> x + 1; }
```
```java
// com.lib.close.module-file.java
module com.lib.close {
    //　exports com.lib.close; // 非公開パッケージ
}
```

* 公開パッケージ

```java
// com.lib.open.PublicA.java
package com.lib.open; import java.util.function.Function;
public class PublicA {
    public Function<Integer, Integer> addTwo = x -> x + 2;　}
```

```java
// com.lib.open.module-file.java
module com.lib.open {
    exports com.lib.open;　// 公開パッケージ
}
```



### Java Module System プロダクト コード

* 非公開パッケージを使用し，ビルド エラーとなるのか実験する

```java
// com.product.Main.java
package com.product;

import com.lib.open.PublicA;
import com.lib.close.PrivateB;

public class Main {
    public static void main(String[] args) {
        final PublicA a = new PublicA();
        System.out.println(a.addTwo.apply(1));

        final PrivateB b = new PrivateB();
        System.out.println(b.addOne.apply(1));
    }
}
```

```java
// com.product.module-file.java
module com.product {
    requires com.lib.open;
    //　requires com.lib.close; // 非公開なので読込不可
}
```



### Java Module System 実行

* Java Module System を使わないビルド 「成功」

```bash
javac -d modules/com.lib.close src/com/lib/close/*
javac -d modules/com.lib.open src/com/lib/open/*
javac -d modules/com.product -cp modules/com.lib.close:modules/com.lib.open src/com/product/Main.java
java -cp modules/com.product:modules/com.lib.open:modules/com.lib.close com.product.Main
3
2
```

* Java Module System を使ったビルド 「失敗」

```bash
javac -d modules/com.lib.close src/com/lib/close/module-info.java src/com/lib/close/*
javac -d modules/com.lib.open src/com/lib/open/module-info.java src/com/lib/open/*
javac -p modules -d modules/com.product src/com/product/module-info.java src/com/product/Main.java
src/com/product/Main.java:4: error: package com.lib.close does not exist
import com.lib.close.PrivateB; // 非公開パッケージの使用をビルドエラーで検出できる
java -p modules -m com.product/com.product.Main
```



## Java Module System を使った感想

* このクールなライブラリを使ってみて！ところでモジュール名を調べる方法は？ 
<!-- .element: class="fragment" data-fragment-index="10" -->
 * jdeps コマンドでモジュール一覧を取得可能👍
<!-- .element: class="fragment" data-fragment-index="15" -->
* module-info.java の名前を変えるとコンパイル エラーが発生する
<!-- .element: class="fragment" data-fragment-index="20" -->
```bash
module declarations should be in a file named module-info.java
```
<!-- .element: class="fragment" data-fragment-index="20" -->
* 主要 IDE の Module サポートが必須
<!-- .element: class="fragment" data-fragment-index="30" -->
 * コマンド ビルド辛い
<!-- .element: class="fragment" data-fragment-index="30" -->
 * 従来のビルド方法ではビルドが成功してしまう
<!-- .element: class="fragment" data-fragment-index="30" -->
 * watch & on the fly の Module ビルドがサポートされないと非公開パッケージに気づき難い
<!-- .element: class="fragment" data-fragment-index="30" -->



## HTTP/2 Client

* [JEP 110: HTTP/2 Client](http://openjdk.java.net/jeps/110)
* 1999 年 6 月 RFC 2616 HTTP/1.1
<!-- .element: class="fragment" data-fragment-index="10" -->
* 2015 年 5 月 RFC 7540 HTTP/2 が標準化
<!-- .element: class="fragment" data-fragment-index="10" -->
* HTTP の Head-of-line Blocking (HoL) で同時接続数が制限されていた
<!-- .element: class="fragment" data-fragment-index="20" -->
 * フロントエンド側で concat，minify，CSS スプライト，CSS や画像のインライン化などの努力をしていた
<!-- .element: class="fragment" data-fragment-index="20" -->
* ストリームの多重化，ヘッダの圧縮，フロー制御などで改善（ざっくり🙇）
<!-- .element: class="fragment" data-fragment-index="25" -->
* JDK 9 HttpClient 以外の HTTP/2 Client
<!-- .element: class="fragment" data-fragment-index="30" -->
 * [Jetty Client](http://www.eclipse.org/jetty/documentation/current/http2.html)
<!-- .element: class="fragment" data-fragment-index="30" -->
 * [Netty Client](http://netty.io/)
<!-- .element: class="fragment" data-fragment-index="30" -->
 * [OkHttp Client](http://square.github.io/okhttp/)
<!-- .element: class="fragment" data-fragment-index="30" -->



## HTTP/2 Client 使い方

* Java Module System で `java.httpclient` を requires する

```java
// src/com/product/module-info.java
module com.product {
    requires java.httpclient;
}
```

```java
// src/com/product/Main.java
final CompletableFuture<String> bodyAsync = HttpClient.create().build()
        .request(URI.create("https://twitter.com/"))
        //.version(HttpClient.Version.HTTP_2) // java.io.IOException: Connection aborted
        .GET()
        .responseAsync()
        .thenCompose(response -> {
            if (response.statusCode() == 200) {
                return response.bodyAsync(HttpResponse.asString());
            } else {
                return CompletableFuture.completedFuture(null);
            }
        })
        .thenApply(body -> body);

System.out.println(bodyAsync.get());
```

```java
javac -d modules/com.product src/com/product/module-info.java src/com/product/Main.java
java -p modules -m com.product/com.product.Main
```



## HTTP/2 Client を使った感想

* 早速 Module System が必要なのか，お前は。。。
<!-- .element: class="fragment" data-fragment-index="10" -->



## 続きは Qiita で！

* Qiita, 「今のうちに知っておきたい、かゆい所に手が届くJava9の新機能7選」, http://qiita.com/kashira2339/items/ce99d370eabbf2d66ded
* Qiita, 「Java9で追加されたメソッド一覧とその使い方」, http://qiita.com/hcl/items/c684aa1b85d2425f0151
* Qiita, 「Java9で文字列の結合の速度を確認する」, http://qiita.com/deaf_tadashi/items/73b9d4ecbfe6f8b14e8f



# Thanks!



## 参考ノート

* Wikipedia, "Java version history - Java SE 9", https://en.wikipedia.org/wiki/Java_version_history#Java_SE_9
* Open JDK, "JDK 9", http://openjdk.java.net/projects/jdk9/
* Ben Evance, 「プレリリース版で学ぶJava 9モジュール」, http://www.oracle.com/webfolder/technetwork/jp/javamagazine/Java-JF16-Java9Modules.pdf
* Wikipedia, 「HTTP/2」, https://ja.wikipedia.org/wiki/HTTP/2
* HTTP/2 and REST, "HTTP/2 Java Client Examples", http://unrestful.io/2015/10/10/http2-java-client-examples.html
* キャッシュ屋blog,「HTTP/2の特徴 HTTP/1.1との違いについて」, http://blog.redbox.ne.jp/http2-cdn.html
* Stackoverflow, "“package java.net.http does not exist” error on JDK9", http://stackoverflow.com/questions/36910746/package-java-net-http-does-not-exist-error-on-jdk9
